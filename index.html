<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>AR Army Men — Zappar Instant World Tracking</title>

<!-- A-Frame + Zappar (CDN) -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://libs.zappar.com/zappar-aframe/2.0.1/zappar-aframe.js"></script>

<style>
  :root { color-scheme: dark }
  html,body { margin:0; height:100%; overflow:hidden; background:#000; font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif }
  #ui { position:fixed; inset:0; pointer-events:none }
  #topbar,#bottombar { position:absolute; left:0; right:0; display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; pointer-events:auto }
  #topbar { top:env(safe-area-inset-top); padding:.5rem }
  #bottombar { bottom:calc(env(safe-area-inset-bottom) + .25rem); padding:.5rem }
  button { appearance:none; border:1px solid #2a2f39; background:#11161d; color:#cbd5e1; border-radius:12px; padding:.6rem .8rem; font-weight:600 }
  #status { position:absolute; left:.5rem; bottom:calc(env(safe-area-inset-bottom) + .5rem); color:#9aa4b2; font-size:.85rem; max-width:46ch; text-shadow:0 1px 2px #000 }
  #start { position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1200px 800px at 50% 0%, rgba(21,27,36,.92), rgba(0,0,0,.96)); z-index:3 }
  #start>div { text-align:center; max-width:40rem; padding:1rem }
  .hb { position:absolute; width:56px; height:7px; border:1px solid rgba(255,255,255,.35); background:rgba(0,0,0,.35); border-radius:4px; overflow:hidden; transform:translate(-50%, -100%); pointer-events:none }
  .hb .f { height:100%; background:linear-gradient(90deg,#22c55e,#84cc16); width:100% }
  .hb.tan .f { background:linear-gradient(90deg,#fbbf24,#f59e0b) }
</style>
</head>
<body>

<!-- Start overlay -->
<div id="start"><div>
  <h1 style="color:#e2e8f0;margin:.5rem 0 .25rem">AR Army Men (Zappar)</h1>
  <p style="color:#a5b4c2;margin:.25rem 0 .75rem">Move to detect a good spot, then tap <b>Place Battlefield</b>. Use the buttons to spawn squads, tanks, and helicopter drops.</p>
  <button id="btnStart">Start</button>
  <p style="color:#94a3b8;font-size:.85rem;margin-top:.5rem">Must be HTTPS (GitHub Pages). Allow camera & motion permissions.</p>
</div></div>

<!-- A-Frame Scene with Zappar Instant World Tracking -->
<a-scene
  renderer="colorManagement: true; physicallyCorrectLights: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false"
  embedded
  style="display:none"
>
  <!-- Permission & compatibility UIs from Zappar -->
  <a-entity zappar-permissions-ui></a-entity>
  <a-entity zappar-compatibility-ui></a-entity>

  <!-- Zappar camera -->
  <!-- Optional: add license-key: YOUR_KEY_HERE if you have one -->
  <a-camera id="camera" zappar-camera></a-camera>

  <!-- Instant world anchor; starts in placement mode -->
  <a-entity id="anchor" zappar-instant="placement-mode: true; placement-smoothing: 0.25;">
    <!-- Battlefield root -->
    <a-entity id="field" position="0 0 0" rotation="0 0 0" scale="1.6 1.6 1.6"></a-entity>

    <!-- Visual gizmo to show the center line -->
    <a-entity geometry="primitive: box; width: 0.02; height: 0.002; depth: 3.2"
              material="color: #24a3ff; opacity: 0.6"
              position="0 0 0"></a-entity>

    <!-- Lights -->
    <a-entity light="type: hemisphere; intensity: 0.9; color: #ffffff; groundColor: #444444"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="1 3 2"></a-entity>
  </a-entity>
</a-scene>

<!-- UI -->
<div id="ui">
  <div id="topbar">
    <button id="btnPlace">Place Battlefield</button>
    <button id="btnGreenSquad">+ Green Squad</button>
    <button id="btnTanSquad">+ Tan Squad</button>
    <button id="btnGreenTank">+ Green Tank</button>
    <button id="btnTanTank">+ Tan Tank</button>
    <button id="btnDropGreen">Heli Drop (Green)</button>
    <button id="btnDropTan">Heli Drop (Tan)</button>
  </div>
  <div id="bottombar">
    <button id="btnReset">Reset</button>
  </div>
  <div id="status">Move your phone to find a spot…</div>
</div>

<script>
// ===== helpers =====
const $ = (id)=>document.getElementById(id);
const rnd = (a=0,b=1)=>a+Math.random()*(b-a);

// ===== Start flow =====
$('btnStart').addEventListener('click', ()=>{
  document.querySelector('a-scene').style.display='block';
  document.getElementById('start').style.display='none';
});

// ===== Audio (simple synth, no files) =====
const AudioFX = (()=>{ let ctx;
  const ensure=()=>{ ctx||(ctx=new (window.AudioContext||window.webkitAudioContext)()); };
  const beep=(f=440,d=.06)=>{ if(!ctx) return; const t=ctx.currentTime, o=ctx.createOscillator(), g=ctx.createGain();
    o.type='square'; o.frequency.value=f; g.gain.value=.0001;
    g.gain.exponentialRampToValueAtTime(.12,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.connect(g).connect(ctx.destination); o.start(t); o.stop(t+d);
  };
  const boom=()=>{ if(!ctx) return; const t=ctx.currentTime, o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sawtooth'; o.frequency.setValueAtTime(180,t); o.frequency.exponentialRampToValueAtTime(60,t+.35);
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.2,t+.02); g.gain.exponentialRampToValueAtTime(.0001,t+.5);
    o.connect(g).connect(ctx.destination); o.start(t); o.stop(t+.6);
  };
  return { ensure, beep, boom };
})();

// ===== Game state =====
const SIDE={GREEN:0,TAN:1};
const units=[]; // {el,type,side,hp,cd}
const cfg={ soldierSpeed:.45, tankSpeed:.25, bulletSpeed:6, fireCooldown:.9, tankCooldown:1.6, soldierHP:100, tankHP:300, dmg:{bullet:25,shell:70}, range:6, collideR:.18 };

let fieldEl = null;
window.addEventListener('load', ()=>{
  fieldEl = document.getElementById('field');
});

// ===== Placement control =====
$('btnPlace').addEventListener('click', ()=>{
  // Turn off placement-mode so the anchor is locked in space
  const anchor = document.getElementById('anchor');
  anchor.setAttribute('zappar-instant', 'placement-mode', 'false');
  $('status').textContent = 'Battlefield placed. Spawn units!';
});

// ===== Spawning & AI =====
function frontlineXZ(side,min=.6,max=2.0){
  const x = (side===SIDE.GREEN? rnd(min,max): -rnd(min,max));
  const z = rnd(-1.2,1.2);
  return new THREE.Vector3(x,0,z);
}

function box(w,h,d,color){
  const el=document.createElement('a-entity');
  el.setAttribute('geometry',`primitive: box; width:${w}; height:${h}; depth:${d}`);
  el.setAttribute('material',`color:${color}; metalness:.1; roughness:.9`);
  fieldEl.appendChild(el);
  return el;
}

function spawnSoldier(side){
  const col = (side===SIDE.GREEN? '#34d399' : '#dcc18f');
  const el = box(.06,.12,.06,col);
  const p = frontlineXZ(side); el.object3D.position.copy(p);
  el.setAttribute('data-type','soldier');
  el.setAttribute('data-side',side);
  el.setAttribute('data-hp', cfg.soldierHP);
  el.setAttribute('data-cd', Math.random()*0.3);
  units.push({el,type:'soldier',side,hp:cfg.soldierHP,cd:Math.random()*0.3});
}

function spawnTank(side){
  const col = (side===SIDE.GREEN? '#34d399' : '#dcc18f');
  const base = box(.18,.09,.28,col);
  const p = frontlineXZ(side,.8,2.2); base.object3D.position.copy(p);
  const gun = box(.04,.04,.16,'#222'); gun.object3D.position.set(0,.06,.12); base.appendChild(gun);
  base.setAttribute('data-type','tank');
  base.setAttribute('data-side',side);
  base.setAttribute('data-hp', cfg.tankHP);
  base.setAttribute('data-cd', Math.random()*0.6);
  units.push({el:base,type:'tank',side,hp:cfg.tankHP,cd:Math.random()*0.6});
}

function spawnHeli(side){
  const col = (side===SIDE.GREEN? '#34d399' : '#dcc18f');
  const heli = box(.12,.06,.28,col);
  const xz = frontlineXZ(side,1.5,2.8); heli.object3D.position.copy(xz); heli.object3D.position.y = 2.2;
  const rotor = box(.28,.01,.01,'#eee'); heli.appendChild(rotor);
  heli.setAttribute('data-type','heli'); heli.setAttribute('data-side',side); heli.setAttribute('data-hp',120);
  units.push({el:heli,type:'heli',side,hp:120,cd:1.5});
  return heli;
}

function dropPara(side){
  let heli = units.find(u=>u.type==='heli' && u.side===side);
  if(!heli) heli = { el: spawnHeli(side) };
  const p = heli.el.object3D.position.clone()
    .add(new THREE.Vector3(rnd(-.2,.2), -.05, rnd(-.2,.2)));
  const para = box(.06,.12,.06, side===SIDE.GREEN? '#34d399' : '#dcc18f');
  para.object3D.position.copy(p);
  const chute = box(.16,.02,.16,'#e6eef9'); chute.object3D.position.set(0,.18,0); para.appendChild(chute);
  para.setAttribute('data-type','para'); para.setAttribute('data-side',side); para.setAttribute('data-hp', cfg.soldierHP);
  fieldEl.appendChild(para);
  units.push({el:para,type:'para',side,hp:cfg.soldierHP,cd:0});
}

// Buttons
$('btnGreenSquad').onclick = ()=>{ AudioFX.ensure(); for(let i=0;i<5;i++) spawnSoldier(SIDE.GREEN); };
$('btnTanSquad').onclick   = ()=>{ AudioFX.ensure(); for(let i=0;i<5;i++) spawnSoldier(SIDE.TAN); };
$('btnGreenTank').onclick  = ()=>{ AudioFX.ensure(); spawnTank(SIDE.GREEN); };
$('btnTanTank').onclick    = ()=>{ AudioFX.ensure(); spawnTank(SIDE.TAN); };
$('btnDropGreen').onclick  = ()=>{ AudioFX.ensure(); dropPara(SIDE.GREEN); };
$('btnDropTan').onclick    = ()=>{ AudioFX.ensure(); dropPara(SIDE.TAN); };
$('btnReset').onclick      = ()=>{ if(!fieldEl) return; [...fieldEl.children].forEach(c=>c.remove()); units.length=0; };

// AI / movement / shooting
AFRAME.registerComponent('army-loop',{
  tick: function(t,dtms){
    const dt=Math.min(.032, dtms/1000);
    const get = (el,k,def)=>{ const v=el.getAttribute(k); return v!=null? (typeof v==='string'? (isNaN(+v)? v : +v): v): def };

    // sync DOM attrs
    for(const u of units){ u.hp = get(u.el,'data-hp', u.hp); u.cd = get(u.el,'data-cd', u.cd); }

    for(const u of units){
      const obj=u.el.object3D;
      if(u.type==='heli'){
        obj.position.x += (u.side===SIDE.GREEN? .2 : -.2) * dt;
      } else if(u.type==='para'){
        if(obj.position.y>0.05) obj.position.y = Math.max(0, obj.position.y - .15*dt);
        else { u.type='soldier'; u.el.setAttribute('data-type','soldier'); }
      } else {
        // ground AI
        let target=null, best=1e9;
        for(const v of units){ if(v.side!==u.side && v.type!=='para'){ const d=obj.position.distanceTo(v.el.object3D.position); if(d<best){best=d; target=v;} } }
        if(target){
          if(best>cfg.collideR*2){
            const dir=target.el.object3D.position.clone().sub(obj.position).normalize();
            const spd=u.type==='tank'?cfg.tankSpeed:cfg.soldierSpeed;
            obj.position.addScaledVector(dir, spd*dt);
          }
          u.cd -= dt; if(u.cd<=0 && best<cfg.range){
            u.cd = (u.type==='tank'? cfg.tankCooldown: cfg.fireCooldown);
            shoot(u, target);
          }
        }
      }
      if(u.hp<=0){ u.dead=true; u.el.remove(); }
    }
    for(let i=units.length-1;i>=0;i--){ if(units[i].dead) units.splice(i,1); }
  }
});
document.querySelector('a-scene').setAttribute('army-loop','');

function shoot(att, tgt){
  AudioFX.beep(att.type==='tank'?160:320,.06);
  tgt.hp = (tgt.hp||100) - (att.type==='tank'?cfg.dmg.shell:cfg.dmg.bullet);
  tgt.el.setAttribute('data-hp', tgt.hp);
}
</script>
</body>
</html>
